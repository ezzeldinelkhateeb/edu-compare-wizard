# 🎯 الخطة النهائية لسير العمل: نظام المقارنة الذكي للمناهج التعليمية

## 🚀 ملخص النظام

هذا المستند يمثل المرجع الأساسي لـ **"نظام التحليل التدريجي الذكي"**، وهو خط إنتاج (Pipeline) متكامل مصمم لمقارنة صفحات المناهج التعليمية بكفاءة ودقة عالية، مع التركيز على **توفير التكاليف** و**الاعتمادية**.

النظام مصمم لمعالجة **دفعات كبيرة من الملفات (Batch Processing)** وتقديم نتائج واضحة ومنظمة.

---

## 🌊 مراحل سير العمل (The Pipeline)

يتبع النظام استراتيجية تدريجية من 4 مراحل، حيث تنتقل الصورة من مرحلة إلى أخرى فقط عند الحاجة، مما يقلل من استدعاءات API المكلفة.

```mermaid
graph TD
    subgraph "المعالجة الأولية (Batch Processing)"
        A[📁 مجلد 1: 2024] --> C{إيجاد الملفات المشتركة};
        B[📁 مجلد 2: 2025] --> C;
    end

    subgraph "نظام التحليل التدريجي الذكي"
        C --> D{المرحلة 1: المقارنة البصرية السريعة};
        D -- "تشابه < 95%" --> E{المرحلة 2: استخراج النص الذكي (LandingAI)};
        D -- "تشابه ≥ 95% (تطابق عالي)" --> F[✅ نتيجة: تطابق بصري عالي];
        
        E --> G{المرحلة 3: فلترة وتحسين النص};
        G --> H{المرحلة 4: التحليل الدلالي العميق (Gemini)};
        
        H --> I[✅ نتيجة: تقرير مقارنة شامل];
    end

    subgraph "النتائج النهائية"
        F --> J[📊 تقرير نهائي مجمع];
        I --> J;
    end

    style A fill:#f9f,stroke:#333,stroke-width:2px
    style B fill:#f9f,stroke:#333,stroke-width:2px
    style J fill:#bbf,stroke:#333,stroke-width:2px
```

---

## 🔧 تفصيل المراحل

### 📂 المرحلة 0: المعالجة الجماعية (Batch Processing)
- **المدخلات**: مجلدين من الصور (مثل `test/2024` و `test/2025`).
- **العملية**:
  1. يقوم النظام تلقائياً بتحديد جميع الملفات التي لها نفس الاسم في كلا المجلدين.
  2. يتم إنشاء قائمة مهام (queue) للمقارنة، ملف بملف.
  3. يتم معالجة القائمة بالتوازي (parallel processing) لضمان السرعة عند التعامل مع مئات أو آلاف الصور.
- **المخرجات**: قائمة أزواج من الصور جاهزة للدخول في خط الإنتاج.

### 🎯 المرحلة 1: المقارنة البصرية السريعة (0 API Calls)
- **الهدف**: استبعاد الصور المتطابقة بصرياً بسرعة وبدون تكلفة.
- **الخوارزمية**: استخدام نفس الخوارزمية التي تم اختبارها (SSIM + Hashing + Histogram).
- **منطق القرار**:
  - **إذا كان التشابه ≥ 95%**:
    - **القرار**: الصور متطابقة بصرياً بشكل شبه كامل.
    - **الإجراء**: تتوقف المعالجة هنا. يتم تسجيل النتيجة "تطابق بصري عالي (95%+)".
    - **التوفير**: **100%** من تكلفة API لهذه الصورة.
  - **إذا كان التشابه < 95%**:
    - **القرار**: هناك اختلافات بصرية تستدعي المزيد من التحليل.
    - **الإجراء**: تنتقل الصور إلى المرحلة التالية.

### 🤖 المرحلة 2: استخراج النص الذكي - LandingAI (1 API Call)
- **الهدف**: استخراج المحتوى النصي من الصورتين اللتين أظهرتا اختلافات بصرية.
- **الأداة**: `LandingAI`.
- **العملية**: يتم إرسال كل من الصورة القديمة والجديدة إلى LandingAI لاستخراج كل النصوص المتاحة.
- **المخرجات**: ملفان JSON يحتويان على النصوص الأولية المستخرجة مع بيانات إضافية.

### 🧹 المرحلة 3: فلترة وتحسين النص (0 API Calls)
- **الهدف**: تنظيف النص المستخرج من LandingAI وإزالة "الضوضاء" للتركيز على المحتوى التعليمي الفعلي.
- **الأداة**: خدمة `TextOptimizer` الداخلية.
- **العملية**:
  1. يتم تجاهل النصوص التي تمثل وصفاً للأيقونات أو أرقام الصفحات أو ترويسة الصفحة.
  2. يتم تجميع الفقرات والنقاط الرئيسية لتكوين نص متماسك يمثل المحتوى العلمي للصفحة.
  3. يتم إزالة المسافات الزائدة والأسطر الفارغة.
- **المخرجات**: نصّان نظيفان ومصقولان، جاهزان للمقارنة الدلالية.

### 🧠 المرحلة 4: التحليل الدلالي العميق - Gemini (1 API Call)
- **الهدف**: إجراء مقارنة ذكية بين النصين النظيفين، وفهم السياق، وتحديد التغييرات الجوهرية.
- **الأداة**: `Gemini Pro` مع Prompt مصمم خصيصاً.
- **الـ Prompt الذكي**:
  ```text
  أنت خبير في تحليل المناهج التعليمية ومقارنتها. مهمتك هي مقارنة النصين التاليين المستخرجين من نسختين (قديمة وجديدة) من صفحة كتاب مدرسي.

  معطيات:
  - التشابه البصري الأولي بين الصورتين هو: {visual_similarity_score}%.
  - النص من النسخة القديمة:
  {old_text}
  - النص من النسخة الجديدة:
  {new_text}

  المطلوب:
  1.  قم بتحليل دقيق للاختلافات بين النصين.
  2.  **تجاهل التغييرات الطفيفة** مثل إعادة صياغة الجمل بنفس المعنى، أو تغيير ترتيب الكلمات الذي لا يؤثر على المفهوم العلمي.
  3.  **ركز على التغييرات الجوهرية** مثل:
      - إضافة أو حذف أسئلة كاملة.
      - إضافة فقرات شرح جديدة.
      - تغيير أرقام أو بيانات علمية.
      - تعديل كبير في الأمثلة المطروحة.
  4.  بناءً على تحليلك، قدم **نسبة تشابه نهائية من 0 إلى 100**.
  5.  قدم **ملخصاً من سطر واحد** يصف أهم تغيير جوهري تم اكتشافه.

  الرجاء إرجاع الإجابة بصيغة JSON فقط بهذا الشكل:
  {
    "final_similarity_score": <النسبة العددية هنا>,
    "summary_of_changes": "<وصف التغيير الرئيسي هنا>"
  }
  ```
- **المخرجات**: تقرير مقارنة نهائي يتضمن نسبة التشابه النهائية ووصفاً للتغييرات.

---

## 🖥️ واجهة النتائج (شاشة سهلة وواضحة)

سيقوم النظام بطباعة تقرير منظم ومباشر في شاشة الأوامر (console) لكل زوج من الصور، بالإضافة إلى ملخص نهائي.

**مثال للتقرير الفردي:**
```
============================================================
🔄 مقارنة: [101.jpg]
------------------------------------------------------------
- المرحلة 1 (بصري): 🟡 تشابه 70.9% -> يستدعي التحليل
- المرحلة 2 (LandingAI): ✅ تم استخراج النص
- المرحلة 3 (فلترة): ✅ تم تنظيف النص
- المرحلة 4 (Gemini):
  - 🎯 التشابه النهائي: 85%
  - 📝 ملخص التغيير: "تمت إضافة مثال جديد عن قانون نيوتن الثاني"
============================================================
```

**مثال للتقرير النهائي المجمع:**
```
============================================================
📊 ملخص المعالجة الجماعية
------------------------------------------------------------
- إجمالي الصور للمقارنة: 50
- ✅ تطابق بصري (تم التوفير): 15 (30%)
- 🔄 تم تحليلها بالكامل: 35 (70%)
- ⏱️ وقت المعالجة الإجمالي: 5 دقائق و 30 ثانية
- 💰 متوسط التوفير في التكلفة: ~45%
============================================================
```

هذا هو المرجع الشامل الذي سنعمل على أساسه. إنه يجمع بين الدقة، السرعة، وتوفير التكاليف. 